{% extends 'base.html' %}
{% load i18n %}

{% block content %}

<div class="container-fluid">
  <h1 style="text-align: center; margin-bottom: 0;">{% trans "Poem Translation" %}</h1>
  <p style="font-size: 24px; padding-left: 40px;">{% trans "Insert your poem and choose translation engine." %}</p>

  <div class="contact_section2">
      <div class="row">
          <div class="col-md-6">

              <!-- Form to translate the poem -->
              <form id='form' action="" method="post">
                  {% csrf_token %}

                  <div class="translation-settings-container">
                    
                    <!-- Source Language dropdown list -->
                    <select style="flex: 1" name="source_lang" class="form-select" aria-select="Source Language">
                      {% for language in supported_languages %}
                        <option value="{{ language.0 }}" {% if language.0 == source_lang %}selected{% endif %}>{{ language.1 }}</option>
                      {% endfor %}
                    </select>

                    <!-- A simple right arrow -> -->
                    <svg style="margin-left: 10px; margin-right: 10px;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right" viewBox="0 0 16 16">
                      <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/>
                    </svg>

                    <!-- Target Language dropdown list -->
                    <!-- If user is not premium, only show first 3 languages -->
                    <select style="flex: 1; margin-right: 5px;" name="target_lang" class="form-select" aria-select="Target Language">
                      {% for language in supported_languages|slice:"1:" %}
                        {% if not user.is_premium and forloop.counter <= 3 or user.is_premium %}
                          <option value="{{ language.0 }}" {% if language.0 == target_lang %}selected{% endif %}>{{ language.1 }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                    
                    <!-- Language Engine dropdown list -->
                    <select style="flex: 1;" name="language_engine" class="language_engines form-select" aria-select="Translation Service">
                      {% for engine in language_engines %}
                        <option value="{{ engine.0 }}" 
                          {% if engine.0 == language_engine %}selected{% endif %} 
                          data-toggle="tooltip" data-bs-toggle="tooltip" 
                          {% if forloop.counter == 1 %} title="{{ language_engine_tooltips.0 }}" 
                          {% elif forloop.counter == 2 %} title="{{ language_engine_tooltips.1 }}" 
                          {% elif forloop.counter == 3 %} title="{{ language_engine_tooltips.2 }}" 
                          {% endif %}>{{ engine.1 }}
                        </option>
                      {% endfor %}
                    </select>
                    
                    <button type="submit" id="button_translate" class="btn btn-primary shadow-none" style="margin-left: 10px;">{% trans "Translate" %}</button>
                  </div>                  
                  
                  <!-- Original text textarea -->
                  <div class="user_text_section" style="margin-top: 15px;">
                      <textarea required class="message_text" placeholder='{% trans "Insert your poem..." %}' rows="10" id="original" name="original_text">{{ original_text }}</textarea>
                  </div>                    
                </form>
          </div>

          <div class="col-md-6">
              <!-- Form to save the poem to the library -->
              <form id='save-form' action="{% url 'save_translation' %}" method="post">
                  {% csrf_token %}
          
                  <input type="hidden" name="language_engine" value="{{ language_engine }}">
                  <input type="hidden" name="source_lang" value="{{ source_lang }}">
                  <input type="hidden" name="target_lang" value="{{ target_lang }}">

                  <!-- A download button -->
                  <input type="button" onclick="return validateForm()" id="button_download" class="btn btn-outline-primary shadow-none" value="{% trans 'Download' %}">

                  <!-- Save to library button -->
                  {% if not user.is_authenticated %}
                  <span class="tt d-inline-block" tabindex="0" data-toggle="tooltip" title="{% trans 'Sign in to save to library!' %}">
                    <button disabled onclick="return validateForm()" style="pointer-events: none;" id="button_save_translation" type="submit" class="btn btn-success shadow-none">{% trans "Save to Library" %}</button>
                  </span>
                  {% else %}
                  <button onclick="return validateForm()" id="button_save_translation" type="submit" class="btn btn-success shadow-none">{% trans "Save to Library" %}</button>
                  {% endif %}

                  <!-- Translation textarea -->
                  <div class="user_text_section" style="margin-top: 15px;">
                      <textarea readonly required class="message_text translation_text" placeholder="{% trans 'Your translation will be here...' %}" rows="10" name="translation">{{ translation|safe }}</textarea>
                  </div>
                  <input type="hidden" name="original_text" value="{{ original_text }}">
              </form>
          </div>
      </div>
  </div>
</div>

<!-- Check if translation text is empty, do nothing if it is -->
<script>
  function validateForm() {
    var textarea = document.querySelector('.translation_text');
    return textarea.value.trim() !== '';
  }
</script>

<!-- Script for a download button -->
<script>
  document.getElementById('button_download').addEventListener('click', function () {
    let translation = document.querySelector(".translation_text").textContent;
    let filename = translation.slice(0, 20);

    if (translation) {
      let element = document.createElement('a');
      element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(translation));
      element.setAttribute('download', filename);
      element.style.display = 'none';
      document.body.appendChild(element);
      element.click();
      document.body.removeChild(element);
    }
  });
</script>

<!-- Script for setting target_lang options to English and Spanish if language engine is set to ChatGpt_Poet -->
<script>
  const languageEngineDropdown = document.querySelector('select[name="language_engine"]');
  const targetLanguageDropdown = document.querySelector('select[name="target_lang"]');

  // Store the original options when the page loads
  const originalOptions = Array.from(targetLanguageDropdown.options);
    
  function updateTargetLanguageDropdown() {
    if (languageEngineDropdown.value === 'ChatGpt_Poet') {
      const options = targetLanguageDropdown.options;
      const slicedOptions = Array.from(options).slice(0, 2);
      targetLanguageDropdown.innerHTML = '';
      slicedOptions.forEach((option) => {
        targetLanguageDropdown.appendChild(option);
      });
    } else {
      targetLanguageDropdown.innerHTML = '';
      originalOptions.forEach((option) => {
        targetLanguageDropdown.appendChild(option);
      });
    }
  }

  // Call the function on page load
  updateTargetLanguageDropdown();

  // Call the function when languageEngineDropdown changes
  languageEngineDropdown.addEventListener('change', updateTargetLanguageDropdown);

</script>
  
{% endblock %}